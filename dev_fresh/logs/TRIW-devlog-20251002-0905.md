# TRIW 開発ログ / 2025-10-02 09:05 UTC

## 変更サマリ
- **UI: プログレスバー**
  - 実行中のみ表示、完了/失敗時は即アンマウント（非表示）
  - フェーズ表示は A〜F（G はチラ見せ廃止）
  - 所要時間は `PROGRESS_WEIGHTS_MS` で調整可能
- **受け取りメモ (runMemoNoteG)**
  - 末尾を **必ず `by {{djName}}`** で締める（API成功/失敗どちらでも担保）
- **E フェーズ高速化 (evaluate.ts)**
  - `resolved` を **Map で事前インデックス化**（exact lookup O(1)）
  - fuzzy 検索は **タイトル先頭8文字のバケット**に限定して線形走査
  - 評価ロジック（スコア/閾値/年ゲート）は変更なし

## 実測（既存ログからの推定）
- A → B : **15s**
- B → C : **36s**
- C → D : **3s**
- D → E : **0s**
- E → F : **136s** ← ボトルネック
- F → G : **4s**

> 対応：E の探索をインデックス化で短縮。追加でバッチ取得/スロットリングは次の施策へ。

---

## 新規課題
**課題:** リストの表示と、実際の Spotify のアーティスト名が違っていることがある

### 事象
- カセット/要約シートのトラック一覧で表示される `artist` が、Spotify 上の表記と異なるケースがある。

### 原因仮説
- フロントの整形関数 `extractFinalTracks()` が、`artist` フィールドを **候補由来の値 (`x.artist`) を優先**しており、Spotify 解決後の正規化済みアーティスト名（`x.spotify.artists`）を後順位にしているため。
  ```ts
  // 現状（抜粋）
  artist: x?.artist ?? x?.artists?.[0] ?? x?.spotify?.artists?.[0] ?? "-",
  ```

### 最小修正案（フロント）
- **Spotify 解決結果を最優先**にし、複数アーティストは結合表示する。
  ```ts
  // src/app/playlist/page.tsx の extractFinalTracks を修正
  artist:
    (Array.isArray(x?.spotify?.artists) && x.spotify.artists.length
      ? x.spotify.artists.join(", ")
      : Array.isArray(x?.artists) && x.artists.length
      ? x.artists.join(", ")
      : x?.artist ?? "-"),
  ```
- 同様に `title` も `x.spotify.name` を最優先にするのが無難。
  ```ts
  title: x?.spotify?.name ?? x?.title ?? x?.name ?? "-",
  ```

### 追加確認ポイント（バックエンド）
- `finalizeSetlist`／`E.afterAudit` に渡す要素が `spotify: {{ name, artists[] }}` を **必ず含む**ことを確認。
- D→E→F で **キー名の揺れ**（`artist` vs `artists[]`）がないかを runlog でチェック。

### 受け入れ基準（AC）
- 表示されたアーティスト名が **Spotify の canonical 表記**と一致（複数名は ", " で連結）。
- 代表的ケース（feat./&/日本語・英語混在）で目視確認が取れる。

---

## デバッグログ（継続方針）
- D2 直後: `D2.audit.json`, `D2.norm.json`
- E 前後: `E.picked.beforeAudit(.indexed).json`, `E.picked.afterAudit(.indexed).json`
- finalize 前後（任意）: `F.preFinalize.snapshot.json`, `F.reintroduced.detected.json`
- 系譜: `E.lineage.json`
- 時刻付与: `saveRaw()` で `__tsEpochMs` / `__tsISO` 自動埋め込み（未導入なら導入検討）

## 次のアクション
1. **フロントの `extractFinalTracks()` を上記案に差し替え**（Spotify 表記優先）
2. 新規 run を 1 本流し、**表示名一致**を確認
3. （必要なら）D→E の受け渡しで `spotify.name / artists[]` を常にセットするよう堅牢化

---

### 参考コミット（メッセージ）
- feat(ui): progress bar shows only during run and hides on completion
- fix(memo): ensure ending with 'by {{djName}}' from openai.ts
- perf(evaluate): indexed exact lookup + bucketed fuzzy to cut E-phase time